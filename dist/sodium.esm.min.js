import{BSTree,PriorityQueue,Set}from"typescript-collections";import{Semigroup,concat}from"sanctuary-type-classes";var totalRegistrations=0;function getTotalRegistrations(){return totalRegistrations}var Color,Source=function(){function t(t,n){if(this.registered=!1,this.deregister_=null,null===t)throw new Error("null origin!");this.origin=t,this.register_=n}return t.prototype.register=function(t){var n=this;this.registered||(this.registered=!0,null!==this.register_?this.deregister_=this.register_():(this.origin.increment(t),this.deregister_=function(){return n.origin.decrement(t)}))},t.prototype.deregister=function(t){this.registered&&(this.registered=!1,null!==this.deregister_&&this.deregister_())},t}();!function(t){t[t.black=0]="black",t[t.gray=1]="gray",t[t.white=2]="white",t[t.purple=3]="purple"}(Color||(Color={}));var roots=[],nextID=0,verbose=!1,Vertex=function(){function t(t,n,e){this.targets=[],this.childrn=[],this.visited=!1,this.color=Color.black,this.buffered=!1,this.refCountAdj=0,this.name=t,this.rank=n,this.sources=e,this.id=nextID++}return t.prototype.refCount=function(){return this.targets.length},t.prototype.register=function(t){return this.increment(t)},t.prototype.deregister=function(n){verbose&&console.log("deregister "+this.descr()+" => "+n.descr()),this.decrement(n),t.collectCycles()},t.prototype.incRefCount=function(t){var n=!1;if(0==this.refCount())for(var e=0;e<this.sources.length;e++)this.sources[e].register(this);return this.targets.push(t),t.childrn.push(this),t.ensureBiggerThan(this.rank)&&(n=!0),totalRegistrations++,n},t.prototype.decRefCount=function(t){verbose&&console.log("DEC "+this.descr());for(var n=!1,e=0;e<t.childrn.length;e++)t.childrn[e]===this&&t.childrn.splice(e,1);for(e=0;e<this.targets.length;e++)if(this.targets[e]===t){this.targets.splice(e,1),n=!0;break}if(n){if(0==this.refCount())for(e=0;e<this.sources.length;e++)this.sources[e].deregister(this);totalRegistrations--}},t.prototype.addSource=function(t){this.sources.push(t),this.refCount()>0&&t.register(this)},t.prototype.ensureBiggerThan=function(t){if(this.rank>t||this.visited)return!1;this.visited=!0,this.rank=t+1;for(var n=0;n<this.targets.length;n++)this.targets[n].ensureBiggerThan(this.rank);return this.visited=!1,!0},t.prototype.descr=function(){var t=null;switch(this.color){case Color.black:t="black";break;case Color.gray:t="gray";break;case Color.white:t="white";break;case Color.purple:t="purple"}for(var n=this.id+" "+this.name+" ["+this.refCount()+"/"+this.refCountAdj+"] "+t+" ->",e=this.children(),r=0;r<e.length;r++)n=n+" "+e[r].id;return n},t.prototype.children=function(){return this.childrn},t.prototype.increment=function(t){return this.incRefCount(t)},t.prototype.decrement=function(t){this.decRefCount(t),0==this.refCount()?this.release():this.possibleRoots()},t.prototype.release=function(){this.color=Color.black,this.buffered||this.free()},t.prototype.free=function(){for(;this.targets.length>0;)this.decRefCount(this.targets[0])},t.prototype.possibleRoots=function(){this.color!=Color.purple&&(this.color=Color.purple,this.buffered||(this.buffered=!0,roots.push(this)))},t.collectCycles=function(){t.markRoots(),t.scanRoots(),t.collectRoots()},t.markRoots=function(){for(var t=[],n=0;n<roots.length;n++)verbose&&console.log("markRoots "+roots[n].descr()),roots[n].color==Color.purple?(roots[n].markGray(),t.push(roots[n])):(roots[n].buffered=!1,roots[n].color==Color.black&&0==roots[n].refCount()&&roots[n].free());roots=t},t.scanRoots=function(){for(var t=0;t<roots.length;t++)roots[t].scan()},t.collectRoots=function(){for(var t=0;t<roots.length;t++)roots[t].buffered=!1,roots[t].collectWhite();roots=[]},t.prototype.markGray=function(){if(this.color!=Color.gray){this.color=Color.gray;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj--,verbose&&console.log("markGray "+this.descr()),t[n].markGray()}},t.prototype.scan=function(){if(verbose&&console.log("scan "+this.descr()),this.color==Color.gray)if(this.refCount()+this.refCountAdj>0)this.scanBlack();else{this.color=Color.white,verbose&&console.log("scan WHITE "+this.descr());for(var t=this.children(),n=0;n<t.length;n++)t[n].scan()}},t.prototype.scanBlack=function(){this.color=Color.black;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj++,verbose&&console.log("scanBlack "+this.descr()),t[n].color!=Color.black&&t[n].scanBlack()},t.prototype.collectWhite=function(){if(this.color==Color.white&&!this.buffered){verbose&&console.log("collectWhite "+this.descr()),this.color=Color.black,this.refCountAdj=0;for(var t=this.children(),n=0;n<t.length;n++)t[n].collectWhite();this.free()}},t.NULL=new t("user",1e12,[]),t}(),Lambda1=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda1(t,n){return new Lambda1(t,n)}function Lambda1_deps(t){return t instanceof Lambda1?t.deps:[]}function Lambda1_toFunction(t){return t instanceof Lambda1?t.f:t}var Lambda2=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda2(t,n){return new Lambda2(t,n)}function Lambda2_deps(t){return t instanceof Lambda2?t.deps:[]}function Lambda2_toFunction(t){return t instanceof Lambda2?t.f:t}var Lambda3=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda3(t,n){return new Lambda3(t,n)}function Lambda3_deps(t){return t instanceof Lambda3?t.deps:[]}function Lambda3_toFunction(t){return t instanceof Lambda3?t.f:t}var Lambda4=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda4(t,n){return new Lambda4(t,n)}function Lambda4_deps(t){return t instanceof Lambda4?t.deps:[]}function Lambda4_toFunction(t){return t instanceof Lambda4?t.f:t}var Lambda5=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda5(t,n){return new Lambda5(t,n)}function Lambda5_deps(t){return t instanceof Lambda5?t.deps:[]}function Lambda5_toFunction(t){return t instanceof Lambda5?t.f:t}var Lambda6=function(){return function(t,n){this.f=t,this.deps=n}}();function lambda6(t,n){return new Lambda6(t,n)}function Lambda6_deps(t){return t instanceof Lambda6?t.deps:[]}function Lambda6_toFunction(t){return t instanceof Lambda6?t.f:t}function toSources(t){for(var n=[],e=0;e<t.length;e++){var r=t[e];n.push(new Source(r.getVertex__(),null))}return n}var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};function __extends(t,n){extendStatics(t,n);function e(){this.constructor=t}t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var Entry=function(){function t(n,e){this.rank=n,this.action=e,this.seq=t.nextSeq++}return t.prototype.toString=function(){return this.seq.toString()},t.nextSeq=0,t}(),Transaction=function(){function t(){this.inCallback=0,this.toRegen=!1,this.prioritizedQ=new PriorityQueue(function(t,n){return t.rank.rank<n.rank.rank?1:t.rank.rank>n.rank.rank?-1:t.seq<n.seq?1:t.seq>n.seq?-1:0}),this.entries=new Set(function(t){return t.toString()}),this.lastQ=[],this.postQ=null}return t.prototype.requestRegen=function(){this.toRegen=!0},t.prototype.prioritized=function(t,n){var e=new Entry(t,n);this.prioritizedQ.enqueue(e),this.entries.add(e)},t.prototype.last=function(t){this.lastQ.push(t)},t.prototype.post=function(t,n){for(null==this.postQ&&(this.postQ=[]);this.postQ.length<=t;)this.postQ.push(null);var e=this.postQ[t],r=null===e?n:function(){e(),n()};this.postQ[t]=r},t.prototype.checkRegen=function(){if(this.toRegen){this.toRegen=!1,this.prioritizedQ.clear();for(var t=this.entries.toArray(),n=0;n<t.length;n++)this.prioritizedQ.enqueue(t[n])}},t.prototype.isActive=function(){return!!t.currentTransaction},t.prototype.close=function(){for(;this.checkRegen(),!this.prioritizedQ.isEmpty();){var n=this.prioritizedQ.dequeue();this.entries.remove(n),n.action()}for(var e=0;e<this.lastQ.length;e++)this.lastQ[e]();if(this.lastQ=[],null!=this.postQ){for(e=0;e<this.postQ.length;e++)if(null!=this.postQ[e]){var r=t.currentTransaction;try{if(e>0){t.currentTransaction=new t;try{this.postQ[e](),t.currentTransaction.close()}catch(n){throw t.currentTransaction.close(),n}}else t.currentTransaction=null,this.postQ[e]();t.currentTransaction=r}catch(n){throw t.currentTransaction=r,n}}this.postQ=null}},t.onStart=function(n){t.onStartHooks.push(n)},t.run=function(n){var e=t.currentTransaction;if(null===e){if(!t.runningOnStartHooks){t.runningOnStartHooks=!0;try{for(var r=0;r<t.onStartHooks.length;r++)t.onStartHooks[r]()}finally{t.runningOnStartHooks=!1}}t.currentTransaction=new t}try{var o=n();return null===e&&(t.currentTransaction.close(),t.currentTransaction=null),o}catch(n){throw null===e&&(t.currentTransaction.close(),t.currentTransaction=null),n}},t.currentTransaction=null,t.onStartHooks=[],t.runningOnStartHooks=!1,t}(),CoalesceHandler=function(){function t(t,n){this.f=Lambda2_toFunction(t),this.out=n,this.out.getVertex__().sources=this.out.getVertex__().sources.concat(toSources(Lambda2_deps(t))),this.accumValid=!1}return t.prototype.send_=function(t){var n=this;this.accumValid?this.accum=this.f(this.accum,t):(Transaction.currentTransaction.prioritized(this.out.getVertex__(),function(){n.out.send_(n.accum),n.accumValid=!1,n.accum=null}),this.accum=t,this.accumValid=!0)},t}(),Lazy=function(){function t(t){this.f=t}return t.prototype.get=function(){return this.f()},t.prototype.map=function(n){var e=this;return new t(function(){return n(e.f())})},t.prototype.lift=function(n,e){var r=this;return new t(function(){return e(r.f(),n.f())})},t.prototype.lift3=function(n,e,r){var o=this;return new t(function(){return r(o.f(),n.f(),e.f())})},t.prototype.lift4=function(n,e,r,o){var i=this;return new t(function(){return o(i.f(),n.f(),e.f(),r.f())})},t}(),Unit=function(){function t(){}return t.UNIT=new t,t}(),Operational=function(){function t(){}return t.updates=function(t){return t.getStream__()},t.value=function(n){return Transaction.run(function(){var e=new StreamWithSend;Transaction.currentTransaction.prioritized(e.getVertex__(),function(){e.send_(Unit.UNIT)});var r=e.snapshot1(n);return t.updates(n).orElse(r)})},t.defer=function(n){return t.split(n.map(function(t){return[t]}))},t.split=function(t){var n=new StreamWithSend(null);return n.setVertex__(new Vertex("split",0,[new Source(t.getVertex__(),function(){return t.listen_(n.getVertex__(),function(t){for(var e=function(e){Transaction.currentTransaction.post(e,function(){Transaction.run(function(){n.send_(t[e])})})},r=0;r<t.length;r++)e(r)},!1)})])),n},t}(),LazySample=function(){return function(t){this.hasValue=!1,this.value=null,this.cell=t}}(),ApplyState=function(){return function(){this.f=null,this.f_present=!1,this.a=null,this.a_present=!1}}(),Cell=function(){function t(t,n){var e=this;this.value=t,n?Transaction.run(function(){return e.setStream(n)}):(this.str=new Stream,this.vertex=new Vertex("ConstCell",0,[]))}return t.prototype.setStream=function(t){var n=this;this.str=t;var e=this,r=new Source(t.getVertex__(),function(){return t.listen_(e.vertex,function(t){null==e.valueUpdate&&Transaction.currentTransaction.last(function(){e.value=e.valueUpdate,e.lazyInitValue=null,e.valueUpdate=null}),e.valueUpdate=t},!1)});this.vertex=new Vertex("Cell",0,[r]),this.vertex.register(Vertex.NULL),Transaction.currentTransaction.last(function(){n.vertex.deregister(Vertex.NULL)})},t.prototype.getVertex__=function(){return this.vertex},t.prototype.getStream__=function(){return this.str},t.prototype.sample=function(){var t=this;return Transaction.run(function(){return t.sampleNoTrans__()})},t.prototype.sampleNoTrans__=function(){return this.value},t.prototype.sampleLazy=function(){var t=this;return Transaction.run(function(){return t.sampleLazyNoTrans__()})},t.prototype.sampleLazyNoTrans__=function(){var t=this,n=new LazySample(t);return Transaction.currentTransaction.last(function(){n.value=null!=t.valueUpdate?t.valueUpdate:t.sampleNoTrans__(),n.hasValue=!0,n.cell=null}),new Lazy(function(){return n.hasValue?n.value:n.cell.sample()})},t.prototype.map=function(t){var n=this;return Transaction.run(function(){return Operational.updates(n).map(t).holdLazy(n.sampleLazy().map(Lambda1_toFunction(t)))})},t.prototype.lift=function(n,e){var r=Lambda2_toFunction(e),o=this.map(function(t){return function(n){return r(t,n)}});return t.apply(o,n,toSources(Lambda2_deps(e)))},t.prototype.lift3=function(n,e,r){var o=Lambda3_toFunction(r),i=this.map(function(t){return function(n){return function(e){return o(t,n,e)}}});return t.apply(t.apply(i,n),e,toSources(Lambda3_deps(r)))},t.prototype.lift4=function(n,e,r,o){var i=Lambda4_toFunction(o),s=this.map(function(t){return function(n){return function(e){return function(r){return i(t,n,e,r)}}}});return t.apply(t.apply(t.apply(s,n),e),r,toSources(Lambda4_deps(o)))},t.prototype.lift5=function(n,e,r,o,i){var s=Lambda5_toFunction(i),a=this.map(function(t){return function(n){return function(e){return function(r){return function(o){return s(t,n,e,r,o)}}}}});return t.apply(t.apply(t.apply(t.apply(a,n),e),r),o,toSources(Lambda5_deps(i)))},t.prototype.lift6=function(n,e,r,o,i,s){var a=Lambda6_toFunction(s),u=this.map(function(t){return function(n){return function(e){return function(r){return function(o){return function(i){return a(t,n,e,r,o,i)}}}}}});return t.apply(t.apply(t.apply(t.apply(t.apply(u,n),e),r),o),i,toSources(Lambda6_deps(s)))},t.apply=function(t,n,e){return Transaction.run(function(){var r=new ApplyState,o=new StreamWithSend,i=Operational.value(t),s=Operational.value(n),a=new Source(i.getVertex__(),function(){return i.listen_(o.getVertex__(),function(t){r.f=t,r.f_present=!0,r.a_present&&o.send_(r.f(r.a))},!1)}),u=new Source(s.getVertex__(),function(){return s.listen_(o.getVertex__(),function(t){r.a=t,r.a_present=!0,r.f_present&&o.send_(r.f(r.a))},!1)});return o.setVertex__(new Vertex("apply",0,[a,u].concat(e||[]))),o.coalesce__(function(t,n){return n}).holdLazy(new Lazy(function(){return t.sampleNoTrans__()(n.sampleNoTrans__())}))})},t.switchC=function(t){return Transaction.run(function(){var n=t.sampleLazy().map(function(t){return t.sample()}),e=new StreamWithSend,r=null,o=Operational.value(t),i=new Source(o.getVertex__(),function(){var t=null===r?null:Operational.value(r).listen_(e.getVertex__(),function(t){return e.send_(t)},!1),n=o.listen_(e.getVertex__(),function(n){r=n,null!==t&&t(),t=Operational.value(n).listen_(e.getVertex__(),function(t){return e.send_(t)},!1)},!1);return function(){n(),t()}});return e.setVertex__(new Vertex("switchC",0,[i])),e.coalesce__(function(t,n){return n}).holdLazy(n)})},t.switchS=function(t){return Transaction.run(function(){var n=new StreamWithSend,e=function(t){n.send_(t)},r=new Source(t.getVertex__(),function(){var r=t.sampleNoTrans__().listen_(n.getVertex__(),e,!1),o=t.getStream__().listen_(n.getVertex__(),function(t){r(),r=t.listen_(n.getVertex__(),e,!0)},!1);return function(){o(),r()}});return n.setVertex__(new Vertex("switchS",0,[r])),n})},t.prototype.listen=function(t){var n=this;return Transaction.run(function(){return Operational.value(n).listen(t)})},t["fantasy-land/of"]=function(n){return new t(n)},t.prototype["fantasy-land/map"]=function(t){return this.map(t)},t.prototype["fantasy-land/ap"]=function(n){return t.apply(n,this)},t.prototype["fantasy-land/chain"]=function(n){return t.switchC(this.map(n))},t.prototype["fantasy-land/extend"]=function(n){return new t(n(this))},t.prototype["fantasy-land/extract"]=function(){return this.sample()},t}(),Listener=function(){return function(t,n){this.h=t,this.target=n}}(),LazyCell=function(t){__extends(n,t);function n(n,e){var r=t.call(this,null,null)||this;return Transaction.run(function(){e&&r.setStream(e),r.lazyInitValue=n}),r}return n.prototype.sampleNoTrans__=function(){return null==this.value&&null!=this.lazyInitValue&&(this.value=this.lazyInitValue.get(),this.lazyInitValue=null),this.value},n}(Cell),Stream=function(){function t(t){this.listeners=[],this.firings=[],this.vertex=t||new Vertex("Stream",0,[])}return t.prototype.getVertex__=function(){return this.vertex},t.prototype.map=function(t){var n=this,e=new StreamWithSend(null),r=Lambda1_toFunction(t);return e.vertex=new Vertex("map",0,[new Source(this.vertex,function(){return n.listen_(e.vertex,function(t){e.send_(r(t))},!1)})].concat(toSources(Lambda1_deps(t)))),e},t.prototype.mapTo=function(t){var n=this,e=new StreamWithSend(null);return e.vertex=new Vertex("mapTo",0,[new Source(this.vertex,function(){return n.listen_(e.vertex,function(n){e.send_(t)},!1)})]),e},t.prototype.orElse=function(t){return this.merge(t,function(t,n){return t})},t.prototype.merge_=function(t){var n=this,e=new StreamWithSend,r=new Vertex("merge",0,[]);return r.sources.push(new Source(this.vertex,function(){return n.listen_(r,function(t){e.send_(t)},!1)})),e.vertex.sources=e.vertex.sources.concat([new Source(r,function(){return r.register(e.vertex),function(){r.deregister(e.vertex)}}),new Source(t.vertex,function(){return t.listen_(e.vertex,function(t){e.send_(t)},!1)})]),e},t.prototype.coalesce__=function(t){var n=this,e=new StreamWithSend,r=new CoalesceHandler(t,e);return e.vertex.sources=e.vertex.sources.concat([new Source(this.vertex,function(){return n.listen_(e.vertex,function(t){r.send_(t)},!1)})]).concat(toSources(Lambda2_deps(t))),e},t.prototype.merge=function(t,n){var e=this;return Transaction.run(function(){return e.merge_(t).coalesce__(n)})},t.prototype.filter=function(t){var n=this,e=new StreamWithSend(null),r=Lambda1_toFunction(t);return e.vertex=new Vertex("filter",0,[new Source(this.vertex,function(){return n.listen_(e.vertex,function(t){r(t)&&e.send_(t)},!1)})].concat(toSources(Lambda1_deps(t)))),e},t.prototype.filterNotNull=function(){var t=this,n=new StreamWithSend(null);return n.vertex=new Vertex("filterNotNull",0,[new Source(this.vertex,function(){return t.listen_(n.vertex,function(t){null!==t&&n.send_(t)},!1)})]),n},t.prototype.gate=function(t){return this.snapshot(t,function(t,n){return n?t:null}).filterNotNull()},t.prototype.snapshot1=function(t){var n=this,e=new StreamWithSend(null);return e.vertex=new Vertex("snapshot1",0,[new Source(this.vertex,function(){return n.listen_(e.vertex,function(n){e.send_(t.sampleNoTrans__())},!1)}),new Source(t.getVertex__(),null)]),e},t.prototype.snapshot=function(t,n){var e=this,r=new StreamWithSend(null),o=Lambda2_toFunction(n);return r.vertex=new Vertex("snapshot",0,[new Source(this.vertex,function(){return e.listen_(r.vertex,function(n){r.send_(o(n,t.sampleNoTrans__()))},!1)}),new Source(t.getVertex__(),null)].concat(toSources(Lambda2_deps(n)))),r},t.prototype.snapshot3=function(t,n,e){var r=this,o=new StreamWithSend(null),i=Lambda3_toFunction(e);return o.vertex=new Vertex("snapshot",0,[new Source(this.vertex,function(){return r.listen_(o.vertex,function(e){o.send_(i(e,t.sampleNoTrans__(),n.sampleNoTrans__()))},!1)}),new Source(t.getVertex__(),null),new Source(n.getVertex__(),null)].concat(toSources(Lambda3_deps(e)))),o},t.prototype.snapshot4=function(t,n,e,r){var o=this,i=new StreamWithSend(null),s=Lambda4_toFunction(r);return i.vertex=new Vertex("snapshot",0,[new Source(this.vertex,function(){return o.listen_(i.vertex,function(r){i.send_(s(r,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__()))},!1)}),new Source(t.getVertex__(),null),new Source(n.getVertex__(),null),new Source(e.getVertex__(),null)].concat(toSources(Lambda4_deps(r)))),i},t.prototype.snapshot5=function(t,n,e,r,o){var i=this,s=new StreamWithSend(null),a=Lambda5_toFunction(o);return s.vertex=new Vertex("snapshot",0,[new Source(this.vertex,function(){return i.listen_(s.vertex,function(o){s.send_(a(o,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__()))},!1)}),new Source(t.getVertex__(),null),new Source(n.getVertex__(),null),new Source(e.getVertex__(),null),new Source(r.getVertex__(),null)].concat(toSources(Lambda5_deps(o)))),s},t.prototype.snapshot6=function(t,n,e,r,o,i){var s=this,a=new StreamWithSend(null),u=Lambda6_toFunction(i);return a.vertex=new Vertex("snapshot",0,[new Source(this.vertex,function(){return s.listen_(a.vertex,function(i){a.send_(u(i,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__(),o.sampleNoTrans__()))},!1)}),new Source(t.getVertex__(),null),new Source(n.getVertex__(),null),new Source(e.getVertex__(),null),new Source(r.getVertex__(),null),new Source(o.getVertex__(),null)].concat(toSources(Lambda6_deps(i)))),a},t.prototype.hold=function(t){return new Cell(t,this)},t.prototype.holdLazy=function(t){return new LazyCell(t,this)},t.prototype.collect=function(t,n){return this.collectLazy(new Lazy(function(){return t}),n)},t.prototype.collectLazy=function(t,n){var e=this;return Transaction.run(function(){var r=new StreamLoop,o=r.holdLazy(t),i=e.snapshot(o,n),s=i.map(function(t){return t.a}),a=i.map(function(t){return t.b});return r.loop(a),s})},t.prototype.accum=function(t,n){return this.accumLazy(new Lazy(function(){return t}),n)},t.prototype.accumLazy=function(t,n){var e=this;return Transaction.run(function(){var r=new StreamLoop,o=r.holdLazy(t),i=e.snapshot(o,n);return r.loop(i),i.holdLazy(t)})},t.prototype.once=function(){var t=this;return Transaction.run(function(){return t.gate(t.mapTo(!1).hold(!0))})},t.prototype.listen=function(t){var n=this;return Transaction.run(function(){return n.listen_(Vertex.NULL,t,!1)})},t.prototype.listen_=function(t,n,e){var r=this;this.vertex.register(t)&&Transaction.currentTransaction.requestRegen();var o=new Listener(n,t);if(this.listeners.push(o),!e&&0!=this.firings.length){var i=this.firings.slice();Transaction.currentTransaction.prioritized(t,function(){for(var t=0;t<i.length;t++)n(i[t])})}return function(){for(var n=!1,e=0;e<r.listeners.length;e++)if(r.listeners[e]==o){r.listeners.splice(e,1),n=!0;break}n&&r.vertex.deregister(t)}},t.prototype["fantasy-land/map"]=function(t){return this.map(t)},t.prototype["fantasy-land/concat"]=function(t){return this.merge(t,function(t,n){return Semigroup.test(t)?concat(t,n):t})},t.prototype["fantasy-land/empty"]=function(){return new t},t}(),StreamWithSend=function(t){__extends(n,t);function n(n){return t.call(this,n)||this}return n.prototype.setVertex__=function(t){this.vertex=t},n.prototype.send_=function(t){var n=this;if(0==this.vertex.refCount())throw new Error("send() was invoked before listeners were registered");0==this.firings.length&&Transaction.currentTransaction.last(function(){n.firings=[]}),this.firings.push(t);for(var e=this.listeners.slice(),r=function(n){var r=e[n].h;Transaction.currentTransaction.prioritized(e[n].target,function(){Transaction.currentTransaction.inCallback++;try{r(t),Transaction.currentTransaction.inCallback--}catch(t){throw Transaction.currentTransaction.inCallback--,t}})},o=0;o<e.length;o++)r(o)},n}(Stream),StreamLoop=function(t){__extends(n,t);function n(){var n=t.call(this)||this;if(n.assigned__=!1,n.vertex.name="StreamLoop",null===Transaction.currentTransaction)throw new Error("StreamLoop/CellLoop must be used within an explicit transaction");return n}return n.prototype.loop=function(t){var n=this;if(this.assigned__)throw new Error("StreamLoop looped more than once");this.assigned__=!0,this.vertex.addSource(new Source(t.getVertex__(),function(){return t.listen_(n.vertex,function(t){n.send_(t)},!1)}))},n}(StreamWithSend),StreamSink=function(t){__extends(n,t);function n(n){var e=t.call(this)||this;return n||(n=function(t,n){throw new Error("send() called more than once per transaction, which isn't allowed. Did you want to combine the events? Then pass a combining function to your StreamSink constructor.")}),e.coalescer=new CoalesceHandler(n,e),e}return n.prototype.send=function(t){var n=this;Transaction.run(function(){if(Transaction.currentTransaction.inCallback>0)throw new Error("You are not allowed to use send() inside a Sodium callback");n.coalescer.send_(t)})},n}(StreamWithSend),CellLoop=function(t){__extends(n,t);function n(){return t.call(this,null,new StreamLoop)||this}return n.prototype.loop=function(t){var n=this;Transaction.run(function(){n.getStream__().loop(t.getStream__()),n.lazyInitValue=t.sampleLazy()})},n.prototype.sampleNoTrans__=function(){if(!this.getStream__().assigned__)throw new Error("CellLoop sampled before it was looped");return t.prototype.sampleNoTrans__.call(this)},n}(LazyCell),CellSink=function(t){__extends(n,t);function n(n,e){return t.call(this,n,new StreamSink(e))||this}return n.prototype.send=function(t){this.getStream__().send(t)},n}(Cell),Tuple2=function(){return function(t,n){this.a=t,this.b=n}}(),TimerSystemImpl=function(){return function(){}}(),nextSeq=0,Event=function(){return function(t,n){this.t=t,this.sAlarm=n,this.seq=++nextSeq}}(),TimerSystem=function(){function t(t){var n=this;this.eventQueue=new BSTree(function(t,n){return t.t<n.t?-1:t.t>n.t?1:t.seq<n.seq?-1:t.seq>n.seq?1:0}),Transaction.run(function(){n.impl=t,n.tMinimum=0;var e=new CellSink(t.now());n.time=e,n.time.listen(function(t){}),Transaction.onStart(function(){for(var r=n.tMinimum=Math.max(n.tMinimum,t.now()),o=function(){var t=null;if(!n.eventQueue.isEmpty()){var o=n.eventQueue.minimum();o.t<=r&&(t=o)}if(null==t)return"break";e.send(t.t),Transaction.run(function(){return t.sAlarm.send_(t.t)})};;){if("break"===o())break}e.send(r)})})}return t.prototype.at=function(t){var n=this,e=null,r=null,o=!1,i=null,s=!1,a=new StreamWithSend(null),u=function(){null!==r&&(r(),n.eventQueue.remove(e)),r=null,e=null,o&&(s||(s=!0,i=t.sampleNoTrans__()),null!==i&&(e=new Event(i,a),n.eventQueue.add(e),r=n.impl.setTimer(i,function(){n.tMinimum=Math.max(n.tMinimum,i),Transaction.run(function(){})})))};return a.setVertex__(new Vertex("at",0,[new Source(t.getVertex__(),function(){o=!0,s=!1,Transaction.currentTransaction.prioritized(a.getVertex__(),u);var n=t.getStream__().listen_(a.getVertex__(),function(t){i=t,s=!0,u()},!1);return function(){o=!1,u(),n()}})])),a},t}(),SecondsTimerSystem=function(t){__extends(n,t);function n(){return t.call(this,new SecondsTimerSystemImpl)||this}return n}(TimerSystem),SecondsTimerSystemImpl=function(t){__extends(n,t);function n(){return null!==t&&t.apply(this,arguments)||this}return n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(1e3*(t-this.now()),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return.001*Date.now()},n}(TimerSystemImpl),MillisecondsTimerSystem=function(t){__extends(n,t);function n(){return t.call(this,new MillisecondsTimerSystemImpl)||this}return n}(TimerSystem),MillisecondsTimerSystemImpl=function(t){__extends(n,t);function n(){return null!==t&&t.apply(this,arguments)||this}return n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(t-this.now(),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return Date.now()},n}(TimerSystemImpl),IOAction=function(){function t(){}return t.fromAsync=function(t){return function(n){var e=new StreamWithSend(null);return e.setVertex__(new Vertex("map",0,[new Source(n.getVertex__(),function(){return n.listen_(e.getVertex__(),function(n){t(n,function(t){Transaction.run(function(){e.send_(t)})})},!1)})])),e}},t}();export{lambda1,lambda2,lambda3,lambda4,lambda5,lambda6,Stream,StreamLoop,StreamSink,Cell,CellLoop,CellSink,Transaction,Tuple2,Unit,Operational,getTotalRegistrations,Vertex,TimerSystemImpl,TimerSystem,SecondsTimerSystem,MillisecondsTimerSystem,IOAction};
//# sourceMappingURL=sodium.esm.min.js.map
