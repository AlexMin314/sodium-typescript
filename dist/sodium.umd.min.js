!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("typescript-collections"),require("sanctuary-type-classes")):"function"==typeof define&&define.amd?define(["exports","typescript-collections","sanctuary-type-classes"],n):n(t.Sodium={},t.Collections,t.Z)}(this,function(t,n,e){"use strict";var r=0;var i,o=function(){function t(t,n){if(this.registered=!1,this.deregister_=null,null===t)throw new Error("null origin!");this.origin=t,this.register_=n}return t.prototype.register=function(t){var n=this;this.registered||(this.registered=!0,null!==this.register_?this.deregister_=this.register_():(this.origin.increment(t),this.deregister_=function(){return n.origin.decrement(t)}))},t.prototype.deregister=function(t){this.registered&&(this.registered=!1,null!==this.deregister_&&this.deregister_())},t}();!function(t){t[t.black=0]="black",t[t.gray=1]="gray",t[t.white=2]="white",t[t.purple=3]="purple"}(i||(i={}));var u=[],s=0,c=function(){function t(t,n,e){this.targets=[],this.childrn=[],this.visited=!1,this.color=i.black,this.buffered=!1,this.refCountAdj=0,this.name=t,this.rank=n,this.sources=e,this.id=s++}return t.prototype.refCount=function(){return this.targets.length},t.prototype.register=function(t){return this.increment(t)},t.prototype.deregister=function(n){this.decrement(n),t.collectCycles()},t.prototype.incRefCount=function(t){var n=!1;if(0==this.refCount())for(var e=0;e<this.sources.length;e++)this.sources[e].register(this);return this.targets.push(t),t.childrn.push(this),t.ensureBiggerThan(this.rank)&&(n=!0),r++,n},t.prototype.decRefCount=function(t){for(var n=!1,e=0;e<t.childrn.length;e++)t.childrn[e]===this&&t.childrn.splice(e,1);for(e=0;e<this.targets.length;e++)if(this.targets[e]===t){this.targets.splice(e,1),n=!0;break}if(n){if(0==this.refCount())for(e=0;e<this.sources.length;e++)this.sources[e].deregister(this);r--}},t.prototype.addSource=function(t){this.sources.push(t),this.refCount()>0&&t.register(this)},t.prototype.ensureBiggerThan=function(t){if(this.rank>t||this.visited)return!1;this.visited=!0,this.rank=t+1;for(var n=0;n<this.targets.length;n++)this.targets[n].ensureBiggerThan(this.rank);return this.visited=!1,!0},t.prototype.descr=function(){var t=null;switch(this.color){case i.black:t="black";break;case i.gray:t="gray";break;case i.white:t="white";break;case i.purple:t="purple"}for(var n=this.id+" "+this.name+" ["+this.refCount()+"/"+this.refCountAdj+"] "+t+" ->",e=this.children(),r=0;r<e.length;r++)n=n+" "+e[r].id;return n},t.prototype.children=function(){return this.childrn},t.prototype.increment=function(t){return this.incRefCount(t)},t.prototype.decrement=function(t){this.decRefCount(t),0==this.refCount()?this.release():this.possibleRoots()},t.prototype.release=function(){this.color=i.black,this.buffered||this.free()},t.prototype.free=function(){for(;this.targets.length>0;)this.decRefCount(this.targets[0])},t.prototype.possibleRoots=function(){this.color!=i.purple&&(this.color=i.purple,this.buffered||(this.buffered=!0,u.push(this)))},t.collectCycles=function(){t.markRoots(),t.scanRoots(),t.collectRoots()},t.markRoots=function(){for(var t=[],n=0;n<u.length;n++)u[n].color==i.purple?(u[n].markGray(),t.push(u[n])):(u[n].buffered=!1,u[n].color==i.black&&0==u[n].refCount()&&u[n].free());u=t},t.scanRoots=function(){for(var t=0;t<u.length;t++)u[t].scan()},t.collectRoots=function(){for(var t=0;t<u.length;t++)u[t].buffered=!1,u[t].collectWhite();u=[]},t.prototype.markGray=function(){if(this.color!=i.gray){this.color=i.gray;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj--,t[n].markGray()}},t.prototype.scan=function(){if(this.color==i.gray)if(this.refCount()+this.refCountAdj>0)this.scanBlack();else{this.color=i.white;for(var t=this.children(),n=0;n<t.length;n++)t[n].scan()}},t.prototype.scanBlack=function(){this.color=i.black;for(var t=this.children(),n=0;n<t.length;n++)t[n].refCountAdj++,t[n].color!=i.black&&t[n].scanBlack()},t.prototype.collectWhite=function(){if(this.color==i.white&&!this.buffered){0,this.color=i.black,this.refCountAdj=0;for(var t=this.children(),n=0;n<t.length;n++)t[n].collectWhite();this.free()}},t.NULL=new t("user",1e12,[]),t}(),a=function(){return function(t,n){this.f=t,this.deps=n}}();function l(t){return t instanceof a?t.deps:[]}function f(t){return t instanceof a?t.f:t}var p=function(){return function(t,n){this.f=t,this.deps=n}}();function h(t){return t instanceof p?t.deps:[]}function _(t){return t instanceof p?t.f:t}var v=function(){return function(t,n){this.f=t,this.deps=n}}();function y(t){return t instanceof v?t.deps:[]}function d(t){return t instanceof v?t.f:t}var g=function(){return function(t,n){this.f=t,this.deps=n}}();function m(t){return t instanceof g?t.deps:[]}function w(t){return t instanceof g?t.f:t}var x=function(){return function(t,n){this.f=t,this.deps=n}}();function T(t){return t instanceof x?t.deps:[]}function V(t){return t instanceof x?t.f:t}var k=function(){return function(t,n){this.f=t,this.deps=n}}();function S(t){return t instanceof k?t.deps:[]}function b(t){return t instanceof k?t.f:t}function N(t){for(var n=[],e=0;e<t.length;e++){var r=t[e];n.push(new o(r.getVertex__(),null))}return n}var C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};function z(t,n){function e(){this.constructor=t}C(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var L=function(){function t(n,e){this.rank=n,this.action=e,this.seq=t.nextSeq++}return t.prototype.toString=function(){return this.seq.toString()},t.nextSeq=0,t}(),Q=function(){function t(){this.inCallback=0,this.toRegen=!1,this.prioritizedQ=new n.PriorityQueue(function(t,n){return t.rank.rank<n.rank.rank?1:t.rank.rank>n.rank.rank?-1:t.seq<n.seq?1:t.seq>n.seq?-1:0}),this.entries=new n.Set(function(t){return t.toString()}),this.lastQ=[],this.postQ=null}return t.prototype.requestRegen=function(){this.toRegen=!0},t.prototype.prioritized=function(t,n){var e=new L(t,n);this.prioritizedQ.enqueue(e),this.entries.add(e)},t.prototype.last=function(t){this.lastQ.push(t)},t.prototype.post=function(t,n){for(null==this.postQ&&(this.postQ=[]);this.postQ.length<=t;)this.postQ.push(null);var e=this.postQ[t],r=null===e?n:function(){e(),n()};this.postQ[t]=r},t.prototype.checkRegen=function(){if(this.toRegen){this.toRegen=!1,this.prioritizedQ.clear();for(var t=this.entries.toArray(),n=0;n<t.length;n++)this.prioritizedQ.enqueue(t[n])}},t.prototype.isActive=function(){return!!t.currentTransaction},t.prototype.close=function(){for(;this.checkRegen(),!this.prioritizedQ.isEmpty();){var n=this.prioritizedQ.dequeue();this.entries.remove(n),n.action()}for(var e=0;e<this.lastQ.length;e++)this.lastQ[e]();if(this.lastQ=[],null!=this.postQ){for(e=0;e<this.postQ.length;e++)if(null!=this.postQ[e]){var r=t.currentTransaction;try{if(e>0){t.currentTransaction=new t;try{this.postQ[e](),t.currentTransaction.close()}catch(n){throw t.currentTransaction.close(),n}}else t.currentTransaction=null,this.postQ[e]();t.currentTransaction=r}catch(n){throw t.currentTransaction=r,n}}this.postQ=null}},t.onStart=function(n){t.onStartHooks.push(n)},t.run=function(n){var e=t.currentTransaction;if(null===e){if(!t.runningOnStartHooks){t.runningOnStartHooks=!0;try{for(var r=0;r<t.onStartHooks.length;r++)t.onStartHooks[r]()}finally{t.runningOnStartHooks=!1}}t.currentTransaction=new t}try{var i=n();return null===e&&(t.currentTransaction.close(),t.currentTransaction=null),i}catch(n){throw null===e&&(t.currentTransaction.close(),t.currentTransaction=null),n}},t.currentTransaction=null,t.onStartHooks=[],t.runningOnStartHooks=!1,t}(),R=function(){function t(t,n){this.f=_(t),this.out=n,this.out.getVertex__().sources=this.out.getVertex__().sources.concat(N(h(t))),this.accumValid=!1}return t.prototype.send_=function(t){var n=this;this.accumValid?this.accum=this.f(this.accum,t):(Q.currentTransaction.prioritized(this.out.getVertex__(),function(){n.out.send_(n.accum),n.accumValid=!1,n.accum=null}),this.accum=t,this.accumValid=!0)},t}(),q=function(){function t(t){this.f=t}return t.prototype.get=function(){return this.f()},t.prototype.map=function(n){var e=this;return new t(function(){return n(e.f())})},t.prototype.lift=function(n,e){var r=this;return new t(function(){return e(r.f(),n.f())})},t.prototype.lift3=function(n,e,r){var i=this;return new t(function(){return r(i.f(),n.f(),e.f())})},t.prototype.lift4=function(n,e,r,i){var o=this;return new t(function(){return i(o.f(),n.f(),e.f(),r.f())})},t}(),A=function(){function t(){}return t.UNIT=new t,t}(),U=function(){function t(){}return t.updates=function(t){return t.getStream__()},t.value=function(n){return Q.run(function(){var e=new B;Q.currentTransaction.prioritized(e.getVertex__(),function(){e.send_(A.UNIT)});var r=e.snapshot1(n);return t.updates(n).orElse(r)})},t.defer=function(n){return t.split(n.map(function(t){return[t]}))},t.split=function(t){var n=new B(null);return n.setVertex__(new c("split",0,[new o(t.getVertex__(),function(){return t.listen_(n.getVertex__(),function(t){for(var e=function(e){Q.currentTransaction.post(e,function(){Q.run(function(){n.send_(t[e])})})},r=0;r<t.length;r++)e(r)},!1)})])),n},t}(),E=function(){return function(t){this.hasValue=!1,this.value=null,this.cell=t}}(),M=function(){return function(){this.f=null,this.f_present=!1,this.a=null,this.a_present=!1}}(),O=function(){function t(t,n){var e=this;this.value=t,n?Q.run(function(){return e.setStream(n)}):(this.str=new H,this.vertex=new c("ConstCell",0,[]))}return t.prototype.setStream=function(t){var n=this;this.str=t;var e=this,r=new o(t.getVertex__(),function(){return t.listen_(e.vertex,function(t){null==e.valueUpdate&&Q.currentTransaction.last(function(){e.value=e.valueUpdate,e.lazyInitValue=null,e.valueUpdate=null}),e.valueUpdate=t},!1)});this.vertex=new c("Cell",0,[r]),this.vertex.register(c.NULL),Q.currentTransaction.last(function(){n.vertex.deregister(c.NULL)})},t.prototype.getVertex__=function(){return this.vertex},t.prototype.getStream__=function(){return this.str},t.prototype.sample=function(){var t=this;return Q.run(function(){return t.sampleNoTrans__()})},t.prototype.sampleNoTrans__=function(){return this.value},t.prototype.sampleLazy=function(){var t=this;return Q.run(function(){return t.sampleLazyNoTrans__()})},t.prototype.sampleLazyNoTrans__=function(){var t=this,n=new E(t);return Q.currentTransaction.last(function(){n.value=null!=t.valueUpdate?t.valueUpdate:t.sampleNoTrans__(),n.hasValue=!0,n.cell=null}),new q(function(){return n.hasValue?n.value:n.cell.sample()})},t.prototype.map=function(t){var n=this;return Q.run(function(){return U.updates(n).map(t).holdLazy(n.sampleLazy().map(f(t)))})},t.prototype.lift=function(n,e){var r=_(e),i=this.map(function(t){return function(n){return r(t,n)}});return t.apply(i,n,N(h(e)))},t.prototype.lift3=function(n,e,r){var i=d(r),o=this.map(function(t){return function(n){return function(e){return i(t,n,e)}}});return t.apply(t.apply(o,n),e,N(y(r)))},t.prototype.lift4=function(n,e,r,i){var o=w(i),u=this.map(function(t){return function(n){return function(e){return function(r){return o(t,n,e,r)}}}});return t.apply(t.apply(t.apply(u,n),e),r,N(m(i)))},t.prototype.lift5=function(n,e,r,i,o){var u=V(o),s=this.map(function(t){return function(n){return function(e){return function(r){return function(i){return u(t,n,e,r,i)}}}}});return t.apply(t.apply(t.apply(t.apply(s,n),e),r),i,N(T(o)))},t.prototype.lift6=function(n,e,r,i,o,u){var s=b(u),c=this.map(function(t){return function(n){return function(e){return function(r){return function(i){return function(o){return s(t,n,e,r,i,o)}}}}}});return t.apply(t.apply(t.apply(t.apply(t.apply(c,n),e),r),i),o,N(S(u)))},t.apply=function(t,n,e){return Q.run(function(){var r=new M,i=new B,u=U.value(t),s=U.value(n),a=new o(u.getVertex__(),function(){return u.listen_(i.getVertex__(),function(t){r.f=t,r.f_present=!0,r.a_present&&i.send_(r.f(r.a))},!1)}),l=new o(s.getVertex__(),function(){return s.listen_(i.getVertex__(),function(t){r.a=t,r.a_present=!0,r.f_present&&i.send_(r.f(r.a))},!1)});return i.setVertex__(new c("apply",0,[a,l].concat(e||[]))),i.coalesce__(function(t,n){return n}).holdLazy(new q(function(){return t.sampleNoTrans__()(n.sampleNoTrans__())}))})},t.switchC=function(t){return Q.run(function(){var n=t.sampleLazy().map(function(t){return t.sample()}),e=new B,r=null,i=U.value(t),u=new o(i.getVertex__(),function(){var t=null===r?null:U.value(r).listen_(e.getVertex__(),function(t){return e.send_(t)},!1),n=i.listen_(e.getVertex__(),function(n){r=n,null!==t&&t(),t=U.value(n).listen_(e.getVertex__(),function(t){return e.send_(t)},!1)},!1);return function(){n(),t()}});return e.setVertex__(new c("switchC",0,[u])),e.coalesce__(function(t,n){return n}).holdLazy(n)})},t.switchS=function(t){return Q.run(function(){var n=new B,e=function(t){n.send_(t)},r=new o(t.getVertex__(),function(){var r=t.sampleNoTrans__().listen_(n.getVertex__(),e,!1),i=t.getStream__().listen_(n.getVertex__(),function(t){r(),r=t.listen_(n.getVertex__(),e,!0)},!1);return function(){i(),r()}});return n.setVertex__(new c("switchS",0,[r])),n})},t.prototype.listen=function(t){var n=this;return Q.run(function(){return U.value(n).listen(t)})},t["fantasy-land/of"]=function(n){return new t(n)},t.prototype["fantasy-land/map"]=function(t){return this.map(t)},t.prototype["fantasy-land/ap"]=function(n){return t.apply(n,this)},t.prototype["fantasy-land/chain"]=function(n){return t.switchC(this.map(n))},t.prototype["fantasy-land/extend"]=function(n){return new t(n(this))},t.prototype["fantasy-land/extract"]=function(){return this.sample()},t}(),j=function(){return function(t,n){this.h=t,this.target=n}}(),I=function(t){function n(n,e){var r=t.call(this,null,null)||this;return Q.run(function(){e&&r.setStream(e),r.lazyInitValue=n}),r}return z(n,t),n.prototype.sampleNoTrans__=function(){return null==this.value&&null!=this.lazyInitValue&&(this.value=this.lazyInitValue.get(),this.lazyInitValue=null),this.value},n}(O),H=function(){function t(t){this.listeners=[],this.firings=[],this.vertex=t||new c("Stream",0,[])}return t.prototype.getVertex__=function(){return this.vertex},t.prototype.map=function(t){var n=this,e=new B(null),r=f(t);return e.vertex=new c("map",0,[new o(this.vertex,function(){return n.listen_(e.vertex,function(t){e.send_(r(t))},!1)})].concat(N(l(t)))),e},t.prototype.mapTo=function(t){var n=this,e=new B(null);return e.vertex=new c("mapTo",0,[new o(this.vertex,function(){return n.listen_(e.vertex,function(n){e.send_(t)},!1)})]),e},t.prototype.orElse=function(t){return this.merge(t,function(t,n){return t})},t.prototype.merge_=function(t){var n=this,e=new B,r=new c("merge",0,[]);return r.sources.push(new o(this.vertex,function(){return n.listen_(r,function(t){e.send_(t)},!1)})),e.vertex.sources=e.vertex.sources.concat([new o(r,function(){return r.register(e.vertex),function(){r.deregister(e.vertex)}}),new o(t.vertex,function(){return t.listen_(e.vertex,function(t){e.send_(t)},!1)})]),e},t.prototype.coalesce__=function(t){var n=this,e=new B,r=new R(t,e);return e.vertex.sources=e.vertex.sources.concat([new o(this.vertex,function(){return n.listen_(e.vertex,function(t){r.send_(t)},!1)})]).concat(N(h(t))),e},t.prototype.merge=function(t,n){var e=this;return Q.run(function(){return e.merge_(t).coalesce__(n)})},t.prototype.filter=function(t){var n=this,e=new B(null),r=f(t);return e.vertex=new c("filter",0,[new o(this.vertex,function(){return n.listen_(e.vertex,function(t){r(t)&&e.send_(t)},!1)})].concat(N(l(t)))),e},t.prototype.filterNotNull=function(){var t=this,n=new B(null);return n.vertex=new c("filterNotNull",0,[new o(this.vertex,function(){return t.listen_(n.vertex,function(t){null!==t&&n.send_(t)},!1)})]),n},t.prototype.gate=function(t){return this.snapshot(t,function(t,n){return n?t:null}).filterNotNull()},t.prototype.snapshot1=function(t){var n=this,e=new B(null);return e.vertex=new c("snapshot1",0,[new o(this.vertex,function(){return n.listen_(e.vertex,function(n){e.send_(t.sampleNoTrans__())},!1)}),new o(t.getVertex__(),null)]),e},t.prototype.snapshot=function(t,n){var e=this,r=new B(null),i=_(n);return r.vertex=new c("snapshot",0,[new o(this.vertex,function(){return e.listen_(r.vertex,function(n){r.send_(i(n,t.sampleNoTrans__()))},!1)}),new o(t.getVertex__(),null)].concat(N(h(n)))),r},t.prototype.snapshot3=function(t,n,e){var r=this,i=new B(null),u=d(e);return i.vertex=new c("snapshot",0,[new o(this.vertex,function(){return r.listen_(i.vertex,function(e){i.send_(u(e,t.sampleNoTrans__(),n.sampleNoTrans__()))},!1)}),new o(t.getVertex__(),null),new o(n.getVertex__(),null)].concat(N(y(e)))),i},t.prototype.snapshot4=function(t,n,e,r){var i=this,u=new B(null),s=w(r);return u.vertex=new c("snapshot",0,[new o(this.vertex,function(){return i.listen_(u.vertex,function(r){u.send_(s(r,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__()))},!1)}),new o(t.getVertex__(),null),new o(n.getVertex__(),null),new o(e.getVertex__(),null)].concat(N(m(r)))),u},t.prototype.snapshot5=function(t,n,e,r,i){var u=this,s=new B(null),a=V(i);return s.vertex=new c("snapshot",0,[new o(this.vertex,function(){return u.listen_(s.vertex,function(i){s.send_(a(i,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__()))},!1)}),new o(t.getVertex__(),null),new o(n.getVertex__(),null),new o(e.getVertex__(),null),new o(r.getVertex__(),null)].concat(N(T(i)))),s},t.prototype.snapshot6=function(t,n,e,r,i,u){var s=this,a=new B(null),l=b(u);return a.vertex=new c("snapshot",0,[new o(this.vertex,function(){return s.listen_(a.vertex,function(o){a.send_(l(o,t.sampleNoTrans__(),n.sampleNoTrans__(),e.sampleNoTrans__(),r.sampleNoTrans__(),i.sampleNoTrans__()))},!1)}),new o(t.getVertex__(),null),new o(n.getVertex__(),null),new o(e.getVertex__(),null),new o(r.getVertex__(),null),new o(i.getVertex__(),null)].concat(N(S(u)))),a},t.prototype.hold=function(t){return new O(t,this)},t.prototype.holdLazy=function(t){return new I(t,this)},t.prototype.collect=function(t,n){return this.collectLazy(new q(function(){return t}),n)},t.prototype.collectLazy=function(t,n){var e=this;return Q.run(function(){var r=new P,i=r.holdLazy(t),o=e.snapshot(i,n),u=o.map(function(t){return t.a}),s=o.map(function(t){return t.b});return r.loop(s),u})},t.prototype.accum=function(t,n){return this.accumLazy(new q(function(){return t}),n)},t.prototype.accumLazy=function(t,n){var e=this;return Q.run(function(){var r=new P,i=r.holdLazy(t),o=e.snapshot(i,n);return r.loop(o),o.holdLazy(t)})},t.prototype.once=function(){var t=this;return Q.run(function(){return t.gate(t.mapTo(!1).hold(!0))})},t.prototype.listen=function(t){var n=this;return Q.run(function(){return n.listen_(c.NULL,t,!1)})},t.prototype.listen_=function(t,n,e){var r=this;this.vertex.register(t)&&Q.currentTransaction.requestRegen();var i=new j(n,t);if(this.listeners.push(i),!e&&0!=this.firings.length){var o=this.firings.slice();Q.currentTransaction.prioritized(t,function(){for(var t=0;t<o.length;t++)n(o[t])})}return function(){for(var n=!1,e=0;e<r.listeners.length;e++)if(r.listeners[e]==i){r.listeners.splice(e,1),n=!0;break}n&&r.vertex.deregister(t)}},t.prototype["fantasy-land/map"]=function(t){return this.map(t)},t.prototype["fantasy-land/concat"]=function(t){return this.merge(t,function(t,n){return e.Semigroup.test(t)?e.concat(t,n):t})},t.prototype["fantasy-land/empty"]=function(){return new t},t}(),B=function(t){function n(n){return t.call(this,n)||this}return z(n,t),n.prototype.setVertex__=function(t){this.vertex=t},n.prototype.send_=function(t){var n=this;if(0==this.vertex.refCount())throw new Error("send() was invoked before listeners were registered");0==this.firings.length&&Q.currentTransaction.last(function(){n.firings=[]}),this.firings.push(t);for(var e=this.listeners.slice(),r=function(n){var r=e[n].h;Q.currentTransaction.prioritized(e[n].target,function(){Q.currentTransaction.inCallback++;try{r(t),Q.currentTransaction.inCallback--}catch(t){throw Q.currentTransaction.inCallback--,t}})},i=0;i<e.length;i++)r(i)},n}(H),P=function(t){function n(){var n=t.call(this)||this;if(n.assigned__=!1,n.vertex.name="StreamLoop",null===Q.currentTransaction)throw new Error("StreamLoop/CellLoop must be used within an explicit transaction");return n}return z(n,t),n.prototype.loop=function(t){var n=this;if(this.assigned__)throw new Error("StreamLoop looped more than once");this.assigned__=!0,this.vertex.addSource(new o(t.getVertex__(),function(){return t.listen_(n.vertex,function(t){n.send_(t)},!1)}))},n}(B),D=function(t){function n(n){var e=t.call(this)||this;return n||(n=function(t,n){throw new Error("send() called more than once per transaction, which isn't allowed. Did you want to combine the events? Then pass a combining function to your StreamSink constructor.")}),e.coalescer=new R(n,e),e}return z(n,t),n.prototype.send=function(t){var n=this;Q.run(function(){if(Q.currentTransaction.inCallback>0)throw new Error("You are not allowed to use send() inside a Sodium callback");n.coalescer.send_(t)})},n}(B),G=function(t){function n(){return t.call(this,null,new P)||this}return z(n,t),n.prototype.loop=function(t){var n=this;Q.run(function(){n.getStream__().loop(t.getStream__()),n.lazyInitValue=t.sampleLazy()})},n.prototype.sampleNoTrans__=function(){if(!this.getStream__().assigned__)throw new Error("CellLoop sampled before it was looped");return t.prototype.sampleNoTrans__.call(this)},n}(I),W=function(t){function n(n,e){return t.call(this,n,new D(e))||this}return z(n,t),n.prototype.send=function(t){this.getStream__().send(t)},n}(O),Y=function(){return function(t,n){this.a=t,this.b=n}}(),Z=function(){return function(){}}(),F=0,J=function(){return function(t,n){this.t=t,this.sAlarm=n,this.seq=++F}}(),K=function(){function t(t){var e=this;this.eventQueue=new n.BSTree(function(t,n){return t.t<n.t?-1:t.t>n.t?1:t.seq<n.seq?-1:t.seq>n.seq?1:0}),Q.run(function(){e.impl=t,e.tMinimum=0;var n=new W(t.now());e.time=n,e.time.listen(function(t){}),Q.onStart(function(){for(var r=e.tMinimum=Math.max(e.tMinimum,t.now()),i=function(){var t=null;if(!e.eventQueue.isEmpty()){var i=e.eventQueue.minimum();i.t<=r&&(t=i)}if(null==t)return"break";n.send(t.t),Q.run(function(){return t.sAlarm.send_(t.t)})};;){if("break"===i())break}n.send(r)})})}return t.prototype.at=function(t){var n=this,e=null,r=null,i=!1,u=null,s=!1,a=new B(null),l=function(){null!==r&&(r(),n.eventQueue.remove(e)),r=null,e=null,i&&(s||(s=!0,u=t.sampleNoTrans__()),null!==u&&(e=new J(u,a),n.eventQueue.add(e),r=n.impl.setTimer(u,function(){n.tMinimum=Math.max(n.tMinimum,u),Q.run(function(){})})))};return a.setVertex__(new c("at",0,[new o(t.getVertex__(),function(){i=!0,s=!1,Q.currentTransaction.prioritized(a.getVertex__(),l);var n=t.getStream__().listen_(a.getVertex__(),function(t){u=t,s=!0,l()},!1);return function(){i=!1,l(),n()}})])),a},t}(),X=function(t){function n(){return t.call(this,new $)||this}return z(n,t),n}(K),$=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return z(n,t),n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(1e3*(t-this.now()),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return.001*Date.now()},n}(Z),tt=function(t){function n(){return t.call(this,new nt)||this}return z(n,t),n}(K),nt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return z(n,t),n.prototype.setTimer=function(t,n){var e=setTimeout(n,Math.max(t-this.now(),0));return function(){clearTimeout(e)}},n.prototype.now=function(){return Date.now()},n}(Z),et=function(){function t(){}return t.fromAsync=function(t){return function(n){var e=new B(null);return e.setVertex__(new c("map",0,[new o(n.getVertex__(),function(){return n.listen_(e.getVertex__(),function(n){t(n,function(t){Q.run(function(){e.send_(t)})})},!1)})])),e}},t}();t.lambda1=function(t,n){return new a(t,n)},t.lambda2=function(t,n){return new p(t,n)},t.lambda3=function(t,n){return new v(t,n)},t.lambda4=function(t,n){return new g(t,n)},t.lambda5=function(t,n){return new x(t,n)},t.lambda6=function(t,n){return new k(t,n)},t.Stream=H,t.StreamLoop=P,t.StreamSink=D,t.Cell=O,t.CellLoop=G,t.CellSink=W,t.Transaction=Q,t.Tuple2=Y,t.Unit=A,t.Operational=U,t.getTotalRegistrations=function(){return r},t.Vertex=c,t.TimerSystemImpl=Z,t.TimerSystem=K,t.SecondsTimerSystem=X,t.MillisecondsTimerSystem=tt,t.IOAction=et,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=sodium.umd.min.js.map
